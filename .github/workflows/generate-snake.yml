name: Generate Snake Animation

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Generate Snake Animation
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: certainly-param
          outputs: |
            dist/github-contribution-grid-snake.svg?color_snake=#00ff00&color_dots=#0d1117,#003300,#006600,#009900,#00ff00
            dist/github-contribution-grid-snake-dark.svg?color_snake=#00ff00&color_dots=#0d1117,#003300,#006600,#009900,#00ff00
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug - Check SVG structure
        run: |
          echo "=== Checking SVG structure ==="
          for file in dist/*.svg; do
            echo "File: $file"
            echo "--- Opacity animations (first 5) ---"
            grep -o '<animate[^>]*opacity[^>]*>' "$file" | head -5 || echo "No opacity animations found"
            echo "--- Opacity animations with to=0 (double quotes) ---"
            grep -o '<animate[^>]*opacity[^>]*to="0"[^>]*>' "$file" | head -3 || echo "No opacity to=\"0\" found"
            echo "--- Opacity animations with to=0 (single quotes) ---"
            grep -o "<animate[^>]*opacity[^>]*to='0'[^>]*>" "$file" | head -3 || echo "No opacity to='0' found"
            echo "--- Sample rect with animations ---"
            grep -A 5 '<rect[^>]*>' "$file" | head -10 || echo "No rects found"
            echo ""
          done
      
      - name: Modify SVG to make eaten boxes purple
        run: |
          python3 << 'EOF'
          import re
          import glob
          from xml.etree import ElementTree as ET
          
          PURPLE = "#9d4edd"
          
          for svg_file in glob.glob("dist/*.svg"):
              print(f"\nProcessing {svg_file}...")
              
              with open(svg_file, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # Try to parse as XML first
              try:
                  # Register namespaces to handle SVG properly
                  ET.register_namespace('', 'http://www.w3.org/2000/svg')
                  
                  tree = ET.parse(svg_file)
                  root = tree.getroot()
                  
                  modifications = 0
                  
                  # Find all animate elements with opacity
                  for animate in root.iter():
                      tag_name = animate.tag.split('}')[-1] if '}' in animate.tag else animate.tag
                      
                      if tag_name == 'animate' and animate.get('attributeName') == 'opacity':
                          to_val = animate.get('to')
                          values_val = animate.get('values')
                          
                          # If opacity goes to 0, add purple fill animation
                          if to_val == '0' or (values_val and '0' in values_val):
                              begin_time = animate.get('begin', '0s')
                              dur_time = animate.get('dur', '0.1s')
                              
                              # Create purple fill animation
                              ns = {'': 'http://www.w3.org/2000/svg'} if '{' in list(root)[0].tag else {}
                              fill_anim = ET.Element('animate', nsmap=ns if ns else None)
                              fill_anim.set('attributeName', 'fill')
                              fill_anim.set('to', PURPLE)
                              fill_anim.set('begin', begin_time)
                              fill_anim.set('dur', dur_time)
                              fill_anim.set('fill', 'freeze')
                              
                              # Insert before opacity animation
                              parent = animate.getparent()
                              if parent is not None:
                                  idx = list(parent).index(animate)
                                  parent.insert(idx, fill_anim)
                                  modifications += 1
                              
                              # Change opacity to stay at 1
                              if to_val == '0':
                                  animate.set('to', '1')
                              if values_val and '0' in values_val:
                                  animate.set('values', values_val.replace('0', '1'))
                  
                  if modifications > 0:
                      # Write back
                      tree.write(svg_file, encoding='utf-8', xml_declaration=True)
                      print(f"  ✓ Modified {modifications} animations using XML parsing")
                  else:
                      print(f"  ⚠ No opacity-to-0 animations found in XML structure")
                      raise Exception("No matches found - trying regex")
                  
              except Exception as e:
                  print(f"  XML parsing failed: {e}, using regex fallback...")
                  
                  # Fallback: Use regex approach
                  def add_purple_fill(match):
                      anim = match.group(0)
                      begin_match = re.search(r'begin=["\']([^"\']+)["\']', anim)
                      begin_time = begin_match.group(1) if begin_match else "0s"
                      
                      dur_match = re.search(r'dur=["\']([^"\']+)["\']', anim)
                      dur_time = dur_match.group(1) if dur_match else "0.1s"
                      
                      # Create purple fill animation
                      fill_anim = f'<animate attributeName="fill" to="{PURPLE}" begin="{begin_time}" dur="{dur_time}" fill="freeze"/>'
                      
                      # Modify opacity to stay at 1
                      anim_modified = anim.replace('to="0"', 'to="1"')
                      anim_modified = re.sub(r'values=["\']([^"\']*)0([^"\']*)["\']', r'values="\11\2"', anim_modified)
                      
                      return fill_anim + anim_modified
                  
                  # Find all opacity animations going to 0
                  content = re.sub(
                      r'<animate[^>]*attributeName=["\']opacity["\'][^>]*to=["\']0["\'][^>]*>',
                      add_purple_fill,
                      content
                  )
                  
                  # Handle values patterns
                  content = re.sub(
                      r'(<animate[^>]*attributeName=["\']opacity["\'][^>]*values=["\'])([^"\']*0[^"\']*)(["\'][^>]*>)',
                      lambda m: add_purple_fill(m.group(0)) if '0' in m.group(2) else m.group(0),
                      content
                  )
                  
                  with open(svg_file, 'w', encoding='utf-8') as f:
                      f.write(content)
                  
                  print(f"  ✓ Modified using regex fallback")
              
              # Verify purple was added
              with open(svg_file, 'r', encoding='utf-8') as f:
                  final_content = f.read()
              
              purple_count = final_content.count(PURPLE)
              print(f"  → Found {purple_count} purple color references in final SVG")
          EOF

      - name: Push to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

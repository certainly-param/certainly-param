name: Generate Snake Animation

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Generate Snake Animation
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: certainly-param
          outputs: |
            dist/github-contribution-grid-snake.svg?color_snake=#00ff00&color_dots=#0d1117,#003300,#006600,#009900,#00ff00
            dist/github-contribution-grid-snake-dark.svg?color_snake=#00ff00&color_dots=#0d1117,#003300,#006600,#009900,#00ff00
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug - Check SVG structure
        run: |
          echo "Checking SVG structure..."
          head -100 dist/*.svg | grep -E "(rect|animate|opacity)" | head -20 || true
      
      - name: Modify SVG to make eaten boxes purple
        run: |
          python3 << 'EOF'
          import re
          import glob
          
          PURPLE = "#9d4edd"
          
          for svg_file in glob.glob("dist/*.svg"):
              with open(svg_file, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              original_len = len(content)
              
              # Strategy: The snake animation likely uses opacity animations
              # We need to find ALL patterns where opacity goes to 0 and replace with purple fill
              
              # Pattern 1: <animate attributeName="opacity" ... to="0" ...>
              # Replace with fill animation to purple + keep opacity at 1
              def replace_opacity_zero(match):
                  anim = match.group(0)
                  
                  # Extract timing
                  begin_match = re.search(r'begin=["\']([^"\']+)["\']', anim)
                  begin_time = begin_match.group(1) if begin_match else "0s"
                  
                  dur_match = re.search(r'dur=["\']([^"\']+)["\']', anim)
                  dur_time = dur_match.group(1) if dur_match else "0.1s"
                  
                  # Create purple fill animation
                  fill_anim = f'<animate attributeName="fill" to="{PURPLE}" begin="{begin_time}" dur="{dur_time}" fill="freeze"/>'
                  
                  # Keep opacity at 1 instead of 0
                  anim_modified = anim.replace('to="0"', 'to="1"')
                  anim_modified = re.sub(r'values=["\']([^"\']*)0([^"\']*)["\']', r'values="\11\2"', anim_modified)
                  
                  return fill_anim + anim_modified
              
              # Find and replace all opacity animations going to 0
              content = re.sub(
                  r'<animate[^>]*attributeName=["\']opacity["\'][^>]*to=["\']0["\'][^>]*>',
                  replace_opacity_zero,
                  content
              )
              
              # Pattern 2: values="...0..." (opacity values ending in 0)
              content = re.sub(
                  r'(<animate[^>]*attributeName=["\']opacity["\'][^>]*values=["\'])([^"\']*0[^"\']*)(["\'][^>]*>)',
                  lambda m: replace_opacity_zero(m.group(0)) if '0' in m.group(2) else m.group(0),
                  content
              )
              
              # Pattern 3: Find rects with opacity animations and add fill animation
              # This handles cases where rects have multiple animations
              def add_purple_to_rect(match):
                  rect_tag = match.group(1)
                  inner_content = match.group(2)
                  
                  # Check if there's an opacity animation going to 0
                  if 'attributeName="opacity"' in inner_content and ('to="0"' in inner_content or ('values=' in inner_content and '0' in inner_content)):
                      # Find the first opacity animation
                      opacity_anim_match = re.search(r'<animate[^>]*attributeName=["\']opacity["\'][^>]*>', inner_content)
                      if opacity_anim_match:
                          anim = opacity_anim_match.group(0)
                          begin_match = re.search(r'begin=["\']([^"\']+)["\']', anim)
                          begin_time = begin_match.group(1) if begin_match else "0s"
                          
                          # Add purple fill animation right after the rect tag
                          fill_anim = f'<animate attributeName="fill" to="{PURPLE}" begin="{begin_time}" dur="0.1s" fill="freeze"/>'
                          
                          # Modify the opacity animation
                          inner_content = inner_content.replace(anim, replace_opacity_zero(opacity_anim_match))
                          
                          return rect_tag + fill_anim + inner_content
                  
                  return match.group(0)
              
              # Process rect blocks
              content = re.sub(
                  r'(<rect[^>]*>)(.*?)(</rect>)',
                  add_purple_to_rect,
                  content,
                  flags=re.DOTALL
              )
              
              # Pattern 4: Direct style opacity:0
              content = re.sub(
                  r'(<rect[^>]*style=["\'])([^"\']*opacity:\s*0[^"\']*)(["\'])',
                  lambda m: m.group(1) + m.group(2).replace('opacity:0', f'fill:{PURPLE};opacity:1') + m.group(3),
                  content
              )
              
              # Count purple occurrences
              purple_count = content.count(PURPLE)
              
              with open(svg_file, 'w', encoding='utf-8') as f:
                  f.write(content)
              
              print(f"Modified {svg_file}: Found {purple_count} purple color references")
          EOF

      - name: Push to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
